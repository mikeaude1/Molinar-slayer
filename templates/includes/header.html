{% load i18n %}
{% load static %}
<header class="header">
  <div class="header-container">
    <div class="header-left">
      <span class="header-logo">{% trans "JMA" %}</span>
    </div>
    <div class="header-title">{% trans "Jesus Molinar Alcaraz" %}</div>
    <form action="/i18n/setlang/" method="post" class="lang-selector-form" id="lang-form">
        {% csrf_token %}
        <input name="next" type="hidden" value="{{ request.path }}">
        <select name="language" class="lang-selector" id="lang-select">
          <option  value="es" {% if request.LANGUAGE_CODE == 'es' %}selected{% endif %}>{% trans "Es" %}</option>
          <option value="en" {% if request.LANGUAGE_CODE == 'en' %}selected{% endif %}>{% trans "En" %}</option>
        </select>
      </form>

    <div class="header-right">
      <button class="menu-icon" aria-label="Open menu">&#9776;</button>
      <div id="dropdown-menu" class="dropdown-menu">
        <ul>
          <li><a href="{% url 'login' %}">{% trans "Iniciar sesión" %}</a></li>
          <li><a href="{% url 'index' %}" id="lang-switch">{% trans "home" %}</a></li>
          <li><a href="{% url 'aboutus' %}">{% trans "Acerca de nosotros" %}</a></li>
          <li><a href="{% url 'practiceareas:practiceareas' %}">{% trans "Áreas de Práctica" %}</a></li>
          <li><a href="{% url 'blog_list' %}">{% trans "Blog" %}</a></li>
        </ul>
      </div>
      <script>
        const menuBtn = document.querySelector('.menu-icon');
        const dropdownMenu = document.getElementById('dropdown-menu');
        menuBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
        });
        document.addEventListener('click', function(e) {
          if (!e.target.closest('.header-right')) {
            dropdownMenu.style.display = 'none';
          }
        });
        // Envío seguro de cambio de idioma vía fetch con CSRF
        const langSelect = document.getElementById('lang-select');
        const langForm = document.getElementById('lang-form');
        function getCookie(name){
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
        }
        function computeNextPath(lang){
          const path = window.location.pathname;
          const parts = path.split('/');
          // parts[0] is '', parts[1] may be 'en' or 'es'
          if (parts.length > 1 && (parts[1] === 'en' || parts[1] === 'es')) {
            parts[1] = lang;
          } else {
            parts.splice(1, 0, lang);
          }
          let newPath = parts.join('/');
          if (!newPath.endsWith('/')) newPath += '/';
          return newPath + window.location.search + window.location.hash;
        }
        langSelect.addEventListener('change', function(){
          const formData = new FormData(langForm);
          const selectedLang = langSelect.value;
          const csrftoken = getCookie('csrftoken');
          // Evitar múltiples navegaciones
          langSelect.disabled = true;
          fetch('/i18n/setlang/', {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrftoken,
            },
            body: formData,
            credentials: 'same-origin',
          }).then(resp => {
            const nextPath = computeNextPath(selectedLang);
            if (resp.ok) {
              // Redirigir a la ruta con prefijo de idioma actualizado
              window.location.replace(nextPath);
            } else {
              // Fallback: navegación directa
              langSelect.disabled = false;
              window.location.href = nextPath;
            }
          }).catch(() => {
            langSelect.disabled = false;
            window.location.href = computeNextPath(selectedLang);
          });
        });
      </script>
    </div>
  </div>
</header>