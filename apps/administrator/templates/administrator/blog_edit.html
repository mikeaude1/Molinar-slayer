{% extends 'administrator/base_admin.html' %}
{% load i18n %}
{% block title %}Editar entrada{% endblock %}
{% block content %}
<div class="card">
  <h1>Editar entrada de blog</h1>
  <p>Modifica los campos necesarios. Puedes reemplazar la imagen subiéndola nuevamente.</p>

  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li class="{{ message.tags }}">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  {% if form.errors %}
    <div class="errorlist">
      <p>Por favor corrige los errores:</p>
      <ul>
        {% for field, errors in form.errors.items %}
          <li><strong>{{ field }}:</strong> {{ errors|striptags }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="post" action="" enctype="multipart/form-data" style="display:grid; gap: .75rem;">
    {% csrf_token %}
    <div>
      <label for="id_title">Título</label>
      {{ form.title }}
    </div>
    <div>
      <label for="id_slug">Slug</label>
      {{ form.slug }}
    </div>

    <div>
      <label for="id_image_url">URL de imagen</label>
      {{ form.image_url }}
      <small>Opcional. Si no proporcionas URL, puedes subir una imagen abajo.</small>
    </div>
    <div>
      <label for="id_image">Imagen (subida)</label>
      {{ form.image }}
      {% if post.image %}
      <div style="margin-top:.5rem;"><strong>Actual:</strong><br><img src="{{ post.image.url }}" alt="{{ post.title }}" style="max-width:240px; height:auto;"/></div>
      {% elif post.image_url %}
      <div style="margin-top:.5rem;"><strong>Actual:</strong><br><img src="{{ post.image_url }}" alt="{{ post.title }}" style="max-width:240px; height:auto;"/></div>
      {% endif %}
    </div>
    <div>
      <label for="id_published">Publicado</label>
      {{ form.published }}
    </div>
    <div>
      <label for="id_active">Activo</label>
      {{ form.active }}
    </div>

    <hr />
    <h2>Artículos</h2>
    {% if formset.non_form_errors %}
      <div class="errorlist">
        {{ formset.non_form_errors }}
      </div>
    {% endif %}
    {{ formset.management_form }}
    <div class="articles" id="articles-container" style="display:grid; gap:.75rem;">
      {% for f in formset.forms %}
        <fieldset class="card" style="padding:.75rem;">
          <legend>Artículo {{ forloop.counter }}</legend>
          {{ f.order }}
          <div>
            <label>Título (opcional)</label>
            {{ f.title }}
          </div>
          <div>
            <label>Contenido</label>
            {{ f.content }}
          </div>
          <div>
            <label>URL de imagen</label>
            {{ f.image_url }}
          </div>
          <div>
            <label>Imagen (subida)</label>
            {{ f.image }}
          </div>
          {% if f.instance and f.instance.image %}
          <div style="margin-top:.5rem;"><strong>Actual:</strong><br><img src="{{ f.instance.image.url }}" alt="{{ f.instance.title|default:'Artículo' }}" style="max-width:180px; height:auto;"/></div>
          {% elif f.instance and f.instance.image_url %}
          <div style="margin-top:.5rem;"><strong>Actual:</strong><br><img src="{{ f.instance.image_url }}" alt="{{ f.instance.title|default:'Artículo' }}" style="max-width:180px; height:auto;"/></div>
          {% endif %}
          {% if f.errors %}
          <div class="errorlist">
            {{ f.errors }}
          </div>
          {% endif %}
          {% if f.DELETE %}
          <div>
            <label>Eliminar</label>
            {{ f.DELETE }}
          </div>
          {% endif %}
        </fieldset>
      {% endfor %}
    </div>

    <div style="display:flex; gap:.5rem; flex-wrap:wrap; margin-top: .5rem;">
      <button type="button" id="add-article" class="btn">Agregar artículo</button>
      <button type="submit" class="btn">Guardar cambios</button>
      <a class="btn" href="{% url 'administrator:blog_list' %}">Volver al listado</a>
    </div>
  </form>
</div>
<script>
(function(){
  const container = document.getElementById('articles-container');
  const addBtn = document.getElementById('add-article');
  const totalFormsName = '{{ formset.management_form.TOTAL_FORMS.name }}';
  const totalFormsInput = document.querySelector(`input[name="${totalFormsName}"]`) || document.querySelector('input[name$="-TOTAL_FORMS"]');
  const emptyFormTemplate = `
    <fieldset class="card" style="padding:.75rem;">
      <legend>Artículo NUEVO</legend>
      {{ formset.empty_form.order.as_widget }}
      <div>
        <label>Título (opcional)</label>
        {{ formset.empty_form.title.as_widget }}
      </div>
      <div>
        <label>Contenido</label>
        {{ formset.empty_form.content.as_widget }}
      </div>
      <div>
        <label>URL de imagen</label>
        {{ formset.empty_form.image_url.as_widget }}
      </div>
      <div>
        <label>Imagen (subida)</label>
        {{ formset.empty_form.image.as_widget }}
      </div>
    </fieldset>
  `;
  if (!addBtn) {
    console.error('Botón "Agregar artículo" no encontrado.');
    return;
  }
  addBtn.addEventListener('click', function(){
    try {
      if (!totalFormsInput || !container) {
        alert('No se puede agregar artículos: formset no inicializado.');
        return;
      }
      const index = parseInt(totalFormsInput.value || '0', 10);
      let html = emptyFormTemplate.replace(/__prefix__/g, index);
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      const fieldset = wrapper.querySelector('fieldset');
      if (!fieldset) {
        console.error('No se pudo crear el fieldset del artículo');
        return;
      }
      const orderInput = fieldset.querySelector('input[name$="-order"]');
      if (orderInput) {
        orderInput.value = index;
      }
      container.appendChild(fieldset);
      totalFormsInput.value = String(index + 1);
    } catch (e) {
      console.error('Error al agregar artículo:', e);
      alert('Ocurrió un error al agregar el artículo. Revisa la consola del navegador.');
    }
  });
})();
</script>
{% endblock %}